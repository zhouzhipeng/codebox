<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>sql执行器</title>
	<style type="text/css">
		body
		{
			font-family: Arial;
			font-size: 10pt;
		}
		table
		{
			border: 1px solid #ccc;
			border-collapse: collapse;
		}
		table th
		{
			background-color: #F7F7F7;
			color: #333;
			font-weight: bold;
		}
		table th, table td
		{
			padding: 5px;
			border-color: #ccc;
		}
	</style>
</head>
<body>

	<textarea id="sqlInput" style="width: 100%; height: 300px;    font-size: 18px; word-break: break-all">
-- @ds=root:123456@tcp(127.0.0.1:3306)/mysql
show tables
	</textarea>

	<input type="button" onclick="runSql(this)" value="Run Selected"/>

	<hr/>
	<pre id="resultBlock" style="    font-size: 18px;"></pre>
	<div id="dvTable" style="font-size: 18px">
	</div>

	<script>
		let KEY_EXEC_PATH= "sql_runner.sql"

		if(localStorage.getItem(KEY_EXEC_PATH)){
			sqlInput.value=localStorage.getItem(KEY_EXEC_PATH)
		}


		async function runSql(btn){
			let txt = window.getSelection ? window.getSelection().toString() : document.selection.creatRange().text;

			if(!txt){
				GenerateTable("Error : Please select some SQL and @ds text firstly!")
				return;
			}

			btn.setAttribute("disabled","disabled")
			btn.value="Running..."


			localStorage.setItem(KEY_EXEC_PATH,sqlInput.value)

			let data = new FormData();
			data.append( "sql", txt);

			let result = await (await fetch("/api/run-sql",
					{
						method: "POST",
						body: data
					})).text()
			// resultBlock.innerHTML= result.trim()

			sqlInput.focus()

			btn.removeAttribute("disabled")
			btn.value="Run Selected"

			dvTable.innerHTML = "";
			result.trim().split("<br/>").map(GenerateTable);
		}
	</script>

	<script type="text/javascript">
		function GenerateTable(arrayData) {

			if(!arrayData.trim()){
				console.log("ignored empty records.")
				return;
			}

			//Create a HTML Table element.
			let  table = document.createElement("TABLE");
			table.border = "1";
			let array = []
			try {
				//convert json array to below array
				array = typeof arrayData != 'object' ? JSON.parse(arrayData) : arrayData;
			}catch (e){
				console.log(e)

				//parse error, display msg colum in table
				array = [{"#msg": arrayData}]
			}

			//Add the header row.
			let row = table.insertRow(-1);
			for (let index in array[0]) {
				let headerCell = document.createElement("TH");
				headerCell.innerHTML = index;
				row.appendChild(headerCell);
			}


			//Add the data rows.
			for (let i = 0; i < array.length; i++) {
				row = table.insertRow(-1);
				for (let index in array[i]) {
					let cell = row.insertCell(-1);
					cell.innerHTML = array[i][index].replaceAll("\n", "<br/>");
				}
			}

			let  dvTable = document.getElementById("dvTable");

			dvTable.appendChild(document.createElement("hr"))
			dvTable.appendChild(table);
		}
	</script>
</body>
</html>
